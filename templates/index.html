<!DOCTYPE html>
<html>
<head>
    <title>GAYM</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="/static/styles.css">
    <style>
         .container_d {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-top: 20px;
            position: relative;
            opacity: 1;
        }

        .btn-go {

            background: radial-gradient(circle at 50% 50%, #3c0607, #d10005);
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            text-transform: uppercase;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            outline: none;
            position: relative;
            z-index: 2;
            margin-left: 20px;
            opacity: 0.8;
        }

        .btn-go:hover {
            transform: scale(1.1);
            box-shadow: 0 18px 20px rgba(0, 0, 0, 0.2);
            background: radial-gradient(circle at 50% 50%, #3c0607, #d10005);
            opacity: 1;
        }

        .btn-go:active {
            transform: scale(1);
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            background: radial-gradient(circle at 50% 50%, #2fff18, #0f7514);
            background: radial-gradient(circle at 50% 50%, #3c0607, #d10005);
            opacity: 1;
        }

        .dart {
            width: 8px;
            height: 60px;
            background-color: red;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            opacity: 0;
            z-index: 1;
        }

        .dart.fly {
            animation: flyDart 1s ease forwards;
        }

        @keyframes flyDart {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) rotate(0deg) scale(1);
            }
            50% {
                transform: translate(-200px, -200px) rotate(180deg) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translate(-400px, -400px) rotate(360deg) scale(0.5);
            }
        }
        form input:focus,
        form button:focus {
            opacity: 1 !important;
        }

        form input,
        form button {
            opacity: 1;
            transition: opacity 0.3s;
        }
        body {
            background: linear-gradient(135deg, #0d1b2a, #1e2a38);
            color: #ffffff;
            font-family: 'Orbitron', sans-serif;
        }
        body > *:not(table) {
            opacity: 1;
        }
        h1, h2 {
            color: #e0f7fa;
        }
        .table {
            background: #dee2e6;
            border-radius: 0px;
            opacity: 1
        }
        .table th, .table td {
            border: 0px solid rgba(255, 255, 255, 0.2);
        }
        .btn-custom {

            border: 2px solid #e0f7fa;
            color: #e0f7fa;
            border-radius: 2px;
            transition: background 0.3s, transform 0.3s;
        }
        .btn-custom:hover {
            background: #e0f7fa;
            color: #1a237e;
            transform: scale(1.05);
        }



        .btn-darts {
            background-color: #ff1744; /* Красный цвет */
            border-radius: 50%; /* Круглая форма кнопки */
            width: 60px;
            height: 60px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            transition: transform 0.3s, background-color 0.3s;
            position: relative;
            overflow: hidden;
            border: none; /* Убираем границу */
        }

        .btn-darts:hover {
            background-color: #00e676; /* Зеленый цвет при наведении */
            transform: scale(1.1); /* Эффект увеличения при наведении */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .btn-darts::before {
            content: "";
            position: absolute;
            width: 200%;
            height: 200%;
            background-color: rgba(255, 255, 255, 0.2);
            top: -75%;
            left: -75%;
            border-radius: 50%;
            transition: 0.5s;
        }

        .btn-darts:hover::before {
            left: 100%;
            transition: 0.5s;
        }



        .alert {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
        }
        .alert.show {
            animation: fadeIn 0s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .disabled-input {
            background-color: #9e9e9e;
            pointer-events: none;
        }
        .highlight-winner {
            background-color: #d4edda !important;
        }


         #winner-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #303030; /* Темный фон */
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            color: #e0f7fa; /* Светло-голубой цвет текста */
            text-align: center;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);

            width: 400px;
            font-family: 'Orbitron', sans-serif;
            animation: dartWinPopup 0.5s ease-in-out forwards;
            opacity: 0.1;
        }

        #winner-popup h3 {
            margin-bottom: 20px;
            font-size: 24px;
            color: #00e676; /* Зеленый цвет для победителя */
            text-transform: uppercase;
            font-weight: bold;
        }

        #winner-popup button {
            margin-top: 10px;
            display: block;
            width: 100%;
            font-size: 18px;
            padding: 10px;
            color: white;
            background-color: #303030; /* Красный цвет для кнопки */
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        #winner-popup button:hover {
            background-color: #00e676; /* Зеленый цвет при наведении */
            transform: scale(1.05); /* Увеличение кнопки */
        }

        @keyframes dartWinPopup {
            from {
                opacity: 0;
                transform: translate(-50%, -70%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }




        /* Эффект для дротика, попадающего в цель */
        @keyframes dartEffect {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(0deg);
            }
            50% {
                opacity: 1;
                transform: scale(1.2) rotate(15deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
            }
        }
        #name {
            width: 300px;

        }
        input#name:focus {
            opacity: 1 !important;
        }

        .btn-max {
            width: 150px;
        }

        /* Adjust max points input size */
        #max-points {
            width: 150px;
        }
        /* Style for the statistics table */
        #statistics-table {
            margin-top: 20px;
            background-color: #1e2a38;
            color: #e0f7fa;
            width: 100%;
            border-collapse: collapse;
        }
        #statistics-table th, #statistics-table td {
            padding: 10px;
            border: 1px solid #0d1130;
            text-align: center;
            opacity: 0.5;
        }
        #statistics-table th {
            opacity: 0.6;
            background-color: #0d1b2a;
        }

        .logo {
            height: 300px;
            opacity: 0.9;
            padding: 0px 0px 10px 0px;
        }


        .logo:hover {
            transform: scale(1.2); /* Увеличиваем логотип на 20% при наведении */
        }


        .main-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }

        .left-buttons {
            display: flex;
            flex-direction: column;
            opacity: 0.4;
        }

    </style>
</head>
<body class="container">
    <div class="main-container">
        <div class="left-buttons">
            <h1 class="mt-5"><></h1>
            <form id="player-form" class="form-inline mb-3">
                <input type="text" id="name" class="form-control mr-2" placeholder="Имя игрока" onkeypress="handleKeyPress(event, 'name')">
                <button type="button" class="btn btn-custom" onclick="addPlayer()">ADD PLAYER</button>
            </form>
            <div class="form-inline mb-3">
                <input type="number" id="max-points" class="form-control mr-2" placeholder="Максимум очков" style="width: 130px" onkeypress="handleKeyPress(event, 'max-points')">
                <button type="button" class="btn btn-custom btn-max" onclick="setMaxPoints()" style="width: 130px;">MAX</button>
            </div>
        </div>

        <div class="container_d">
            <img src="/static/datz.png" alt="Game Logo" class="logo">

            <button class="btn-go" onclick="handleGoClick()">START</button>
            <div class="dart" id="dart1"></div>
            <div class="dart" id="dart2"></div>
            <div class="dart" id="dart3"></div>
        </div>
    </div>




    <h2></h2>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Ввод очков</th>
                <th>Имя</th>
                <th>Очки</th>
                <th>Попытки</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="player-list">
            {% for player in players %}
                {% if player.is_active %}
                    <tr id="player-{{ player.id }}" class="{{ 'highlight-winner' if player.points <= 0 }}">
                        <td>
                            <input type="text" id="input-points-{{ player.id }}" class="form-control"
                                   onkeypress="handleKeyPress(event, {{ player.id }})" value="{{ player.points_per_attempt|join(', ') }}">
                        </td>
                        <td id="name-{{ player.id }}">{{ player.name }}</td>
                        <td id="points-{{ player.id }}"
                            {% if player.points <= 0 %} style="color: green;" {% endif %}>{{ player.points }}</td>
                        <td id="attempts-{{ player.id }}">{{ player.attempts }}</td>
                        <td id="history-{{ player.id }}">
                            {% for points in player.points_per_attempt %}
                                <span>{{ points }}</span>{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </td>
                        <td><button class="btn btn-danger btn-custom" onclick="deletePlayer({{ player.id }})">X</button></td>
                    </tr>
                {% endif %}
            {% endfor %}
        </tbody>
    </table>
    <div id="winner-message" class="alert" style="display: none;"></div>


    <table id="statistics-table" class="table">
        <thead>
            <tr>
                <th>Имя</th>
                <th>Сыграно игр</th>
                <th>Попыток</th>
                <th>Макс. очки за попытку</th>
                <th>Победы</th>
                <th>Процент побед</th>
            </tr>
        </thead>
        <tbody>
            {% for player in players %}
            <tr>
                <td>{{ player.name }}</td>
                <td>{{ player.games_played }}</td>
                <td>{{ player.statistics.total_attempts }}</td>
                <td>{{ player.statistics.max_points_in_game }}</td>
                <td>{{ player.statistics.total_wins }}</td>
                <td>
                    {% if player.games_played > 0 %}
                        {{ (player.statistics.total_wins / player.games_played) * 100 }}%
                    {% else %}
                        0%
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Popup для победителя -->
    <div id="winner-popup">
        <h3 id="winner-name">Победитель: </h3>
        <button class="btn btn-darts" onclick="resetGame(); closeWinnerPopup();">Начать заново</button>
        <button class="btn btn-darts" onclick="closeWinnerPopup()">Продолжить</button>
    </div>


    <script>
        let currentInputIndex = 0;
        let isAddingPlayer = false;

        async function addPlayer() {
            if (isAddingPlayer) return;  // Предотвращение двойного вызова
            isAddingPlayer = true;

            const name = document.getElementById('name').value.trim();
            if (!name) {
                alert("Введите имя игрока!");
                isAddingPlayer = false;
                return;
            }

            const response = await fetch('/players/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });

            const player = await response.json();
            const playerList = document.getElementById('player-list');
            const newRow = `<tr id="player-${player.id}">
                                <td>
                                    <input type="text" id="input-points-${player.id}" class="form-control"
                                           onkeypress="handleKeyPress(event, ${player.id})" value="">
                                </td>
                                <td id="name-${player.id}">${player.name}</td>
                                <td id="points-${player.id}">${player.points}</td>
                                <td id="attempts-${player.id}">${player.attempts}</td>
                                <td id="history-${player.id}"></td>
                                <td><button class="btn btn-danger btn-custom" onclick="deletePlayer(${player.id})">X</button></td>
                            </tr>`;
            playerList.innerHTML += newRow;

            document.getElementById('name').value = '';
            isAddingPlayer = false;
        }

        function handleKeyPress(event, fieldId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (fieldId === 'name') {
                    addPlayer();
                } else if (fieldId === 'max-points') {
                    setMaxPoints();
                } else {
                    addPoints(fieldId);
                }
            }
        }

        async function addPoints(playerId) {
            const inputField = document.getElementById(`input-points-${playerId}`);
            const inputValues = inputField.value.split(',').map(Number).filter(n => !isNaN(n));
            const points = inputValues[inputValues.length - 1];

            const response = await fetch(`/players/${playerId}/points?points=${points}`, {
                method: 'POST'
            });

            const result = await response.json();
            const pointsCell = document.getElementById(`points-${playerId}`);
            const attemptsCell = document.getElementById(`attempts-${playerId}`);

            // Проверяем, если пришло сообщение (например, об окончании игры)
            if (result.message) {
                const winnerMessage = document.getElementById('winner-message');
                winnerMessage.innerText = result.message;
                winnerMessage.style.display = 'block';
                winnerMessage.classList.add('show');
                showWinnerMessage(result.message);
            }

            if (result.player) {
                // Если введено больше очков, чем нужно, ход игнорируется
                if (result.player.points < 0) {
                    alert('Ход не засчитан: игрок ввел больше очков, чем нужно.');
                    // Обнуляем результат текущего ввода
                    inputField.value = 0;
                } else {
                    // Обновляем отображение очков и попыток, если ход корректен
                    pointsCell.innerText = result.player.points;
                    attemptsCell.innerText = result.player.attempts;
                    inputField.value += ', '; // Добавляем запятую и пробел для следующего ввода

                    // Если игрок выиграл (набрал 0 очков)
                    if (result.player.points <= 0) {
                        pointsCell.style.color = 'green'; // Подсветить очки победителя
                        pointsCell.parentElement.classList.add('highlight-winner'); // Подсветить строку победителя
                        showWinnerPopup(result.player.name);
                    }
                }

                // Передаем ход следующему игроку в любом случае
                updateInputState();
            }
        }

        function updateInputState() {
            const inputs = Array.from(document.querySelectorAll('[id^="input-points-"]'));
            inputs.forEach((input, index) => {
                if (index === currentInputIndex) {
                    input.classList.remove('disabled-input');
                    input.focus();
                } else {
                    input.classList.add('disabled-input');
                }
            });
            currentInputIndex = (currentInputIndex + 1) % inputs.length;
        }

        function showWinnerMessage(message) {
            const winnerMessage = document.getElementById('winner-message');
            winnerMessage.innerText = message;
            winnerMessage.style.display = 'block';
            winnerMessage.classList.add('show');
            setTimeout(() => {
                winnerMessage.style.display = 'none';
            }, 3000); // 3 секунды
        }

        function showWinnerPopup(winnerName) {
            const winnerPopup = document.getElementById('winner-popup');
            const winnerNameElement = document.getElementById('winner-name');
            winnerNameElement.innerText = `Победитель: ${winnerName}`;
            winnerPopup.style.display = 'block';
        }

        function closeWinnerPopup() {
            const winnerPopup = document.getElementById('winner-popup');
            winnerPopup.style.display = 'none';
        }

        async function resetGame() {
            const maxPoints = document.getElementById('max-points').value || 301;
            const response = await fetch('/reset/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ max_points: maxPoints })
            });
            const result = await response.json();
            if (result.message) {
                document.getElementById('winner-message').style.display = 'none';
                const playerList = document.getElementById('player-list');
                const rows = playerList.getElementsByTagName('tr');
                for (let row of rows) {
                    const pointsCell = row.getElementsByTagName('td')[2];
                    const attemptsCell = row.getElementsByTagName('td')[3];
                    const historyCell = row.getElementsByTagName('td')[4];
                    const inputField = row.getElementsByTagName('td')[0].getElementsByTagName('input')[0];
                    pointsCell.innerText = maxPoints;

                    attemptsCell.innerText = 0;
                    inputField.value = ''; // Reset points history in input field
                    row.classList.remove('highlight-winner'); // Reset background color
                    pointsCell.style.color = ''; // Reset points color
                }
                currentInputIndex = 0;
                updateInputState();
            }
        }

        async function deletePlayer(playerId) {
            const response = await fetch(`/players/${playerId}/`, {
                method: 'DELETE'
            });
            if (response.status === 200) {
                const playerRow = document.getElementById(`player-${playerId}`);
                playerRow.remove();
            }
        }

        async function setMaxPoints() {
            const maxPoints = document.getElementById('max-points').value;
            if (!maxPoints || isNaN(maxPoints) || maxPoints <= 0) {
                alert("Введите корректное значение для максимальных очков.");
                return;
            }
            alert(`Максимальные очки установлены: ${maxPoints}`);
            const response = await fetch('/players/', { method: 'GET' });
            const players = await response.json();
            players.forEach(player => {
                const pointsCell = document.getElementById(`points-${player.id}`);
                pointsCell.innerText = "Press START!"; // Update the points column to reflect new max points
                pointsCell.style.color = ''; // Reset the color just in case
        });
        }
        async function loadStatistics() {
            const response = await fetch('/statistics/');
            const statistics = await response.json();

            const statsTable = document.getElementById('statistics-table');
            statsTable.innerHTML = ''; // Очистить текущие данные

            statistics.forEach(stat => {
                const row = `<tr>
                                <td>${stat.player_name}</td>
                                <td>${stat.games_played}</td>
                                <td>${stat.games_won}</td>
                                <td>${stat.win_percentage}%</td>
                            </tr>`;
                statsTable.innerHTML += row;
            });
        }
        function handleGoClick() {
            resetGame();
            throwDarts();
        }
        function throwDarts() {
            const dart1 = document.getElementById('dart1');
            const dart2 = document.getElementById('dart2');
            const dart3 = document.getElementById('dart3');

            // Добавляем класс "fly" к дротикам, чтобы началась анимация
            dart1.classList.add('fly');
            setTimeout(() => dart2.classList.add('fly'), 200); // Задержка перед запуском второго дротика
            setTimeout(() => dart3.classList.add('fly'), 400); // Задержка перед запуском третьего дротика

            // Очищаем классы после завершения анимации, чтобы можно было запустить снова
            setTimeout(() => {
                dart1.classList.remove('fly');
                dart2.classList.remove('fly');
                dart3.classList.remove('fly');
            }, 1500);
        }
        document.getElementById('name').addEventListener('focus', function() {
            document.querySelector('.left-buttons').style.opacity = 1; //
        });
        document.getElementById('name').addEventListener('blur', function() {
            document.querySelector('.left-buttons').style.opacity = 0.4; //
        });
        document.getElementById('max-points').addEventListener('focus', function() {
            document.querySelector('.left-buttons').style.opacity = 1; //
        });
        document.getElementById('max-points').addEventListener('blur', function() {
            document.querySelector('.left-buttons').style.opacity = 0.4; //
        });
                /*
        document.getElementById('name').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addPlayer();
            }
        });*/
    </script>
</body>
</html>